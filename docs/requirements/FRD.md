# 功能需求文档 (FRD - Functional Requirements Document)

## 📋 目录 / Table of Contents

- [引言 / Introduction](#引言--introduction)
- [整体功能概述 / Overall Functional Overview](#整体功能概述--overall-functional-overview)
- [详细功能需求 / Detailed Functional Requirements](#详细功能需求--detailed-functional-requirements)
- [用户界面需求 / User Interface Requirements](#用户界面需求--user-interface-requirements)
- [数据流图 / Data Flow Diagrams](#数据流图--data-flow-diagrams)
- [功能优先级 / Functional Priorities](#功能优先级--functional-priorities)

## 引言 / Introduction

### 文档目的 / Purpose

本文档详细描述和谐历史档案馆系统的功能需求，基于现有代码实现，为开发、测试和维护提供参考。

### 范围 / Scope

本文档涵盖系统所有核心功能模块，包括文章管理、多媒体资料管理、搜索功能、数据筛选等。

### 相关文档 / Related Documents

- [URD - 用户需求文档](./URD.md) - 用户角色和使用场景
- [NFR - 非功能需求文档](./NFR.md) - 性能、安全等非功能需求
- [SRS - 系统需求规格说明](./SRS.md) - 完整的系统规格说明
- [需求追踪矩阵](./REQUIREMENTS_TRACEABILITY.md) - 需求与实现的追踪关系
- [API文档](../../API.md) - API接口详细说明

### 术语定义 / Terminology

- **文章**: 指历史文献资料的基本单位
- **版本对比**: 不同来源或不同时期的文档对比功能
- **标签系统**: 用于分类和检索的标记系统
- **索引**: 预处理的数据索引，用于快速检索

## 整体功能概述 / Overall Functional Overview

### 核心功能模块 / Core Functional Modules

#### 1. 文章管理系统 / Article Management System

- **文章浏览**: 分页展示文章列表，支持多种排序方式
- **文章详情**: 展示完整文章内容，支持版本对比
- **文章检索**: 基于标题、作者、内容的快速搜索

#### 2. 多媒体管理系统 / Multimedia Management System

- **音乐库**: 音乐作品的管理、播放和歌词版本对比
- **图库**: 历史图片和视频资料的管理
- **播放器**: 音乐播放控制，支持多种播放模式

#### 3. 搜索系统 / Search System

- **全文搜索**: 基于Elasticsearch的全文检索功能
- **高级筛选**: 多维度数据筛选和过滤

#### 4. 数据处理系统 / Data Processing System

- **数据标准化**: 统一的数据格式和处理流程
- **版本管理**: 多版本文档的管理和对比
- **数据校对**: 人工校对和修正功能

## 详细功能需求 / Detailed Functional Requirements

### FR1: 文章列表浏览功能 / Article List Browsing

#### FR1.1 文章列表展示

**描述**: 系统应能够分页展示所有文章，支持多种排序方式。
**优先级**: 高
**输入**:

- 排序字段（标题、作者、日期等）
- 排序方向（升序/降序）
- 页码和每页数量

**输出**:

- 文章列表，包含标题、作者、日期、来源、标签等信息
- 分页信息

**业务规则**:

- 默认按日期降序排序
- 支持100-1000条/页的配置
- 列表项应包含关键信息概览

#### FR1.2 数据筛选功能

**描述**: 用户可以通过多种条件筛选文章列表。
**优先级**: 高

**筛选条件**:

- **时间范围筛选**: 支持年月日范围选择
- **作者筛选**: 支持单选或多选作者
- **来源筛选**: 支持按书籍/期刊筛选
- **标签筛选**: 支持按分类标签筛选

**业务规则**:

- 筛选条件可组合使用
- 支持快速选择常用筛选条件
- 筛选结果实时更新

### FR2: 文章详情展示功能 / Article Detail Display

#### FR2.1 文章内容展示

**描述**: 展示文章的完整内容和元数据信息。
**优先级**: 高

**展示内容**:

- 文章标题和副标题
- 作者信息
- 发表日期
- 来源信息
- 文章正文内容
- 标签信息
- 相关注释

**业务规则**:

- 支持不同内容类型的展示（段落、引用、图片等）
- 保持原始排版格式
- 支持内容复制和分享

#### FR2.2 版本对比功能

**描述**: 支持多版本文章内容的对比展示。
**优先级**: 中

**对比类型**:

- **逐字对比 (Literal Comparison)**: 显示文字级别的差异，使用diff-match-patch算法进行字符级差异分析
- **逐行对比 (Line Comparison)**: 显示行级别的差异，按段落或行进行对比
- **描述和注释对比 (Description and Comments Comparison)**: 对比文章的元数据描述和注释内容
- **来源对比 (Source Comparison)**: 显示不同来源版本的差异，支持多个出版物版本对比

**对比模式**:

- **无对比 (none)**: 默认模式，仅显示单个版本
- **原始版本对比 (origin)**: 对比原始解析版本
- **校对后版本对比 (originProofread)**: 对比经过人工校对的版本
- **版本间对比 (version)**: 对比不同出版物版本

**业务规则**:

- 使用颜色编码显示差异（绿色=新增，红色=删除）
- 支持双栏对比展示
- 支持差异导航和跳转
- 使用diff-match-patch库进行差异计算
- 支持实时对比模式切换
- 对比结果可导出或分享

**实现细节**:

- 基于 `diff-match-patch` 库实现差异算法
- 支持大规模文本的差异计算
- 差异结果实时渲染，性能优化

### FR3: 音乐库管理功能 / Music Library Management

#### FR3.1 音乐列表展示

**描述**: 展示所有音乐作品的基本信息。
**优先级**: 中

**展示字段**:

- 音乐名称
- 作曲者
- 作词者
- 艺术家/演唱者
- 艺术形式
- 歌词版本数量
- 来源信息
- 标签

**业务规则**:

- 支持按歌词版本数量排序
- 支持标签筛选
- 支持艺术家信息展示

#### FR3.2 音乐播放功能

**描述**: 提供音乐播放和控制功能。
**优先级**: 中

**播放控制**:

- 播放/暂停/停止
- 上一首/下一首
- 进度控制
- 音量控制

**播放模式**:

- 单曲循环
- 顺序播放
- 随机播放

**业务规则**:

- 支持多版本歌词选择
- 支持歌词下载
- 播放状态实时同步

#### FR3.3 歌词版本对比

**描述**: 支持不同版本歌词的对比展示。
**优先级**: 中

**对比功能**:

- 双栏歌词对比
- 差异高亮显示
- 支持多个版本同时对比

### FR4: 图库管理功能 / Gallery Management

#### FR4.1 图片/视频列表展示

**描述**: 展示所有多媒体资料。
**优先级**: 中

**展示内容**:

- 缩略图预览
- 名称和描述
- 来源信息
- 时间信息
- 标签信息

**业务规则**:

- 支持点击显示原图
- 支持按时间和标签筛选
- 支持图片和视频分类展示

### FR5: 搜索功能 / Search Functionality

#### FR5.1 本地搜索

**描述**: 基于Google搜索的简单检索功能。
**优先级**: 中

**搜索范围**:

- 网站内全文搜索
- 支持关键词匹配

#### FR5.2 Elasticsearch搜索

**描述**: 基于Elasticsearch的全文检索功能。
**优先级**: 高

**搜索特性**:

- **精确短语搜索**: 支持完整短语匹配
- **多字段搜索**: 支持标题、内容、作者等字段
- **布尔查询**: 支持AND/OR/NOT逻辑
- **高亮显示**: 搜索结果关键词高亮
- **分页展示**: 支持大量结果的分页浏览

**性能要求**:

- 搜索响应时间 < 2秒
- 支持并发搜索请求
- 支持复杂查询语法

### FR6: 数据筛选系统 / Data Filtering System

#### FR6.1 时间筛选

**描述**: 支持按时间范围筛选数据。
**优先级**: 高

**时间筛选选项**:

- 年份范围选择（起始年份-结束年份）
- 月份范围选择（起始月份-结束月份）
- 日期范围选择（起始日期-结束日期）
- 支持日期范围和多个时间点
- 支持日期范围类型（is_range_date）的判断

**筛选逻辑**:

- 对于日期范围类型文章：检查文章日期范围是否完全包含在筛选范围内
- 对于多个时间点类型文章：检查所有时间点是否都在筛选范围内
- 默认时间范围：1800年1月1日 - 2200年12月31日

**交互流程**:

1. 用户点击时间筛选按钮
2. 弹出时间选择对话框
3. 用户选择起始和结束时间（年/月/日）
4. 系统实时应用筛选条件
5. 文章列表更新显示筛选结果
6. 筛选条件显示在筛选器区域

**业务规则**:

- 默认时间范围：1800-2200年
- 支持快速选择常用时间段
- 筛选条件可清除和重置
- 支持精确到日期的筛选

#### FR6.2 作者筛选

**描述**: 支持按作者筛选内容。
**优先级**: 高

**筛选方式**:

- 预设常用作者快速选择（如：毛泽东、江青、王洪文、张春桥、姚文元）
- 支持搜索和选择更多作者
- 支持多作者组合筛选（OR逻辑）
- 支持作者名称的模糊匹配

**交互流程**:

1. 用户点击作者筛选按钮
2. 弹出作者选择对话框
3. 显示常用作者列表和搜索框
4. 用户选择单个或多个作者
5. 系统应用筛选条件
6. 文章列表显示包含任一选中作者的文章

**业务规则**:

- 支持多作者选择（文章包含任一作者即匹配）
- 作者名称支持中文和英文
- 筛选条件可清除
- 常用作者列表可配置

#### FR6.3 来源筛选

**描述**: 支持按来源筛选内容。
**优先级**: 高

**来源类型**:

- 书籍来源（如：毛泽东选集、毛泽东全集、毛泽东文集）
- 期刊来源（如：人民日报、红旗杂志）
- 其他来源（如：中国文化大革命文库）

**交互流程**:

1. 用户点击来源筛选按钮
2. 弹出来源选择对话框
3. 显示所有可用来源列表
4. 用户选择单个或多个来源
5. 系统应用筛选条件
6. 文章列表显示来自选中来源的文章

**业务规则**:

- 支持多来源选择（OR逻辑）
- 来源名称从文章数据中提取
- 支持来源名称搜索
- 常用来源可预设

#### FR6.4 标签筛选

**描述**: 支持按标签筛选内容。
**优先级**: 高

**标签类型**:

- **文稿大类**: 中央文件、重要报刊和社论、关键人物文稿、群众运动重要文献
- **文稿类型**: 文章、书信、发言、对话、宣言、指示、批示、通讯
- **地点标签**: 地理位置的标记
- **人物标签**: 历史人物的标记
- **主题事件标签**: 历史事件和主题的标记

**交互流程**:

1. 用户点击标签筛选按钮
2. 弹出标签选择对话框
3. 按标签类型分组显示
4. 用户选择标签（可多选）
5. 系统应用筛选条件
6. 文章列表显示包含选中标签的文章

**业务规则**:

- 支持多标签选择（AND逻辑，文章需包含所有选中标签）
- 支持按标签类型筛选
- 标签显示格式：`类型--名称`
- 筛选条件可组合使用

#### FR6.5 筛选组合与交互

**描述**: 支持多个筛选条件的组合使用。
**优先级**: 高

**组合规则**:

- 所有筛选条件使用AND逻辑（必须同时满足）
- 同一类型筛选条件内部使用OR逻辑（如：多个作者）
- 筛选结果实时更新
- 支持清除单个或全部筛选条件

**交互特性**:

- 筛选条件显示在数据表格工具栏
- 已应用的筛选条件高亮显示
- 支持快速清除所有筛选
- 筛选状态可通过URL参数保存和分享

### FR7: 数据录入与校对功能 / Data Entry and Correction

#### FR7.1 数据录入

**描述**: 支持新数据的录入和管理。
**优先级**: 中

**录入内容**:

- 原始文档上传
- 元数据录入（标题、作者、日期等）
- 标签标注
- 内容解析配置

#### FR7.2 数据校对

**描述**: 支持人工校对和修正功能。
**优先级**: 中

**校对功能**:

- 文本内容校对
- 格式修正
- 错误标记和修正
- 版本历史记录

### FR8: OCR补丁预览功能 / OCR Patch Preview

#### FR8.1 OCR补丁应用

**描述**: 支持应用OCR补丁并实时预览校对结果。
**优先级**: 中

**功能特性**:

- **补丁格式**: 支持V2版本补丁格式（PatchV2）
- **补丁内容**: 支持段落修改、注释修改、描述修改
- **预览模式**: 创建虚拟预览版本，不影响原始数据
- **实时应用**: 补丁应用后立即显示预览效果

**补丁操作类型**:

- **段落操作**: 插入、删除、修改段落内容和类型
- **注释操作**: 插入、删除、修改注释内容
- **描述操作**: 修改文章描述信息

**业务规则**:

- 补丁预览版本标识为 `--preview-patch--`
- 预览版本名称显示为 `#OCR补丁预览#`
- 支持将补丁应用到指定出版物版本
- 预览版本可用于版本对比功能
- 补丁数据通过JSON格式传递

**使用场景**:

- OCR识别结果的人工校对
- 文本错误的批量修正
- 格式标准化处理
- 内容补充和完善

#### FR8.2 补丁导入功能

**描述**: 支持从外部导入OCR补丁代码。
**优先级**: 低

**导入方式**:

- 支持文本格式的补丁代码导入
- 补丁代码格式：`{OCR补丁}{...JSON数据...}`
- 自动解析补丁数据并应用

### FR9: PDF预览功能 / PDF Preview

#### FR9.1 PDF文档预览

**描述**: 支持在浏览器中直接预览PDF格式的原始文档。
**优先级**: 中

**功能特性**:

- **PDF渲染**: 使用react-pdf库进行PDF渲染
- **页面导航**: 支持页面跳转和浏览
- **缩放控制**: 支持缩放比例调整（0.1倍增量）
- **多页面支持**: 支持多页PDF文档的完整浏览

**技术实现**:

- 使用PDF.js库进行PDF解析和渲染
- Worker路径：`/pdfjs-dist/legacy/build/pdf.worker.min.js`
- 支持CMap字体映射：`/pdfjs-dist/cmaps/`
- 默认显示宽度：500px，可缩放

**业务规则**:

- 仅支持PDF类型的书籍文件
- 预览缩放范围：0.1倍到2.0倍（建议）
- 缩放操作通过按钮控制
- 支持PDF文档的完整页面显示
- 不支持数据库文件的预览（显示提示信息）

**使用场景**:

- 查看原始PDF文档
- 验证OCR识别结果
- 对比解析后的文本与原始文档
- 检查文档格式和排版

#### FR9.2 图片预览功能

**描述**: 支持图片格式文档的预览。
**优先级**: 中

**功能特性**:

- 支持常见图片格式（JPG、PNG等）
- 图片缩放预览
- 点击查看原图

## 用户界面需求 / User Interface Requirements

### UI1: 响应式设计

**描述**: 系统应支持多种设备和屏幕尺寸。
**设备支持**:

- 桌面电脑（≥1200px宽度）
- 笔记本电脑（≥768px宽度）
- 平板电脑（≥600px宽度）
- 手机（≥320px宽度）

### UI2: 无障碍访问

**描述**: 系统应支持键盘导航和屏幕阅读器。
**无障碍特性**:

- 键盘快捷键支持
- 语义化HTML结构
- 颜色对比度符合WCAG标准
- 图片提供替代文本

### UI3: 性能优化

**描述**: 用户界面应具有良好的性能表现。
**性能指标**:

- 首屏加载时间 < 3秒
- 页面切换时间 < 1秒
- 支持虚拟滚动处理大数据集

## 用例场景 / Use Case Scenarios

### UC1: 文章版本对比用例 / Article Version Comparison Use Case

**参与者**: 历史研究者
**前置条件**: 用户已打开文章详情页面，文章有多个版本

**主流程**:

1. 用户点击"对比"按钮
2. 系统显示对比类型选择菜单
3. 用户选择对比类型（逐行/逐字/描述和注释）
4. 用户选择要对比的版本（原始版本/校对版本/其他版本）
5. 系统加载两个版本的数据
6. 系统计算差异并高亮显示
7. 用户查看对比结果，识别差异点
8. 用户可切换对比模式查看不同粒度的差异

**异常流程**:

- 如果文章只有一个版本，显示提示信息
- 如果版本数据加载失败，显示错误提示

**后置条件**: 用户完成版本对比，了解版本间的差异

### UC2: OCR补丁预览用例 / OCR Patch Preview Use Case

**参与者**: 数据贡献者
**前置条件**: 用户已打开文章详情页面，有OCR补丁数据

**主流程**:

1. 用户准备OCR补丁数据（JSON格式）
2. 用户通过导入功能或代码方式应用补丁
3. 系统解析补丁数据
4. 系统创建虚拟预览版本（`--preview-patch--`）
5. 系统应用补丁到指定出版物版本
6. 系统显示预览版本（标识为"#OCR补丁预览#"）
7. 用户选择预览版本进行查看
8. 用户可对比预览版本与原始版本
9. 用户确认补丁效果后，可提交补丁到正式版本

**异常流程**:

- 如果补丁格式错误，显示解析错误提示
- 如果补丁应用失败，显示错误信息并回滚

**后置条件**: 用户完成补丁预览，确认补丁效果

### UC3: 多维度数据筛选用例 / Multi-dimensional Filtering Use Case

**参与者**: 历史研究者
**前置条件**: 用户已打开文章列表页面

**主流程**:

1. 用户点击时间筛选按钮
2. 系统显示时间选择对话框
3. 用户选择时间范围（如：1966-1976年）
4. 系统应用时间筛选，更新文章列表
5. 用户点击作者筛选按钮
6. 系统显示作者选择对话框
7. 用户选择作者（如：毛泽东、江青）
8. 系统应用作者筛选，进一步缩小结果
9. 用户点击来源筛选按钮
10. 系统显示来源选择对话框
11. 用户选择来源（如：毛泽东选集）
12. 系统应用来源筛选，显示最终筛选结果
13. 用户可清除任意筛选条件
14. 系统实时更新筛选结果

**异常流程**:

- 如果筛选结果为空，显示"无匹配结果"提示
- 如果筛选条件冲突，显示警告信息

**后置条件**: 用户获得符合所有筛选条件的文章列表

### UC4: PDF文档预览用例 / PDF Preview Use Case

**参与者**: 普通访客/历史研究者
**前置条件**: 用户已打开文章详情页面，文章有PDF格式的原始文件

**主流程**:

1. 用户查看文章详情
2. 系统检测到文章有PDF格式文件
3. 系统显示PDF预览区域
4. 用户查看PDF第一页
5. 用户点击缩放按钮放大PDF
6. 系统增加缩放比例（+0.1倍）
7. 用户浏览PDF其他页面
8. 用户可调整缩放比例查看细节
9. 用户对比PDF原始文档与解析后的文本

**异常流程**:

- 如果PDF文件加载失败，显示错误提示
- 如果PDF文件过大，显示加载进度

**后置条件**: 用户完成PDF预览，验证文档内容

## 数据流图 / Data Flow Diagrams

### 数据流概述 / Data Flow Overview

```
用户请求 → 前端界面 → API调用 → 数据处理 → 结果返回
    ↓         ↓         ↓        ↓         ↓
筛选条件 → 状态管理 → 后端查询 → 索引搜索 → 内容渲染
```

### 主要数据流 / Main Data Flows

#### 文章浏览数据流

1. 用户访问文章列表页面
2. 前端加载文章索引数据（从GitHub Raw Content API）
3. 前端解析索引数据，构建文章列表
4. 用户应用筛选条件
5. 前端过滤和排序数据（客户端处理）
6. 展示筛选结果
7. 用户点击文章，跳转到详情页
8. 前端加载文章完整数据
9. 渲染文章内容和元数据

#### 版本对比数据流

1. 用户选择对比模式和版本
2. 前端加载多个版本的数据
3. 使用diff-match-patch算法计算差异
4. 生成差异结果数组
5. 渲染差异高亮显示
6. 用户可切换对比模式查看不同粒度差异

#### OCR补丁应用数据流

1. 用户提供补丁数据（JSON格式）
2. 系统解析补丁数据
3. 加载目标出版物版本数据
4. 应用补丁操作（插入/删除/修改）
5. 生成预览版本数据
6. 创建虚拟出版物版本
7. 显示预览版本供用户查看

#### 搜索数据流

1. 用户输入搜索关键词
2. 前端判断搜索环境（本地/生产）
3. 构建Elasticsearch查询请求
4. 发送搜索请求到Elasticsearch API
5. Elasticsearch处理查询并返回结果
6. 前端解析搜索结果和高亮片段
7. 渲染搜索结果列表
8. 用户点击结果跳转到文章详情

#### 音乐播放数据流

1. 用户选择音乐作品
2. 前端加载音乐索引数据
3. 用户选择音乐，加载音乐详情
4. 前端加载音乐元数据和歌词数据
5. 用户选择播放版本和歌词版本
6. 音频播放器加载音频文件
7. 歌词同步显示
8. 用户可切换歌词版本进行对比

## 功能优先级 / Functional Priorities

### 高优先级 (P1) / High Priority

- FR1.1 文章列表展示
- FR1.2 数据筛选功能
- FR2.1 文章内容展示
- FR5.2 Elasticsearch搜索
- FR6.1-6.5 所有筛选功能（时间、作者、来源、标签、组合筛选）

### 中优先级 (P2) / Medium Priority

- FR2.2 版本对比功能（逐字、逐行、描述和注释对比）
- FR3.1-3.3 音乐库相关功能
- FR4.1 图库展示功能
- FR5.1 本地搜索
- FR7.1-7.2 数据录入校对功能
- FR8.1 OCR补丁预览功能
- FR9.1 PDF预览功能

### 低优先级 (P3) / Low Priority

- FR8.2 补丁导入功能
- FR9.2 图片预览功能
- 高级数据分析功能
- 批量操作功能
- 导出功能扩展

## 需求实现状态 / Implementation Status

### 已实现功能 / Implemented Features

- ✅ FR1.1 文章列表展示
- ✅ FR1.2 数据筛选功能
- ✅ FR2.1 文章内容展示
- ✅ FR2.2 版本对比功能（完整实现）
- ✅ FR5.2 Elasticsearch搜索
- ✅ FR6.1-6.5 所有筛选功能
- ✅ FR8.1 OCR补丁预览功能
- ✅ FR9.1 PDF预览功能

### 部分实现功能 / Partially Implemented Features

- ⚠️ FR3.1-3.3 音乐库功能（基础功能已实现，高级功能待完善）
- ⚠️ FR4.1 图库展示功能（基础展示已实现，高级筛选待完善）

### 计划实现功能 / Planned Features

- 📋 FR7.1-7.2 数据录入校对功能（后台功能，前端界面待完善）
- 📋 FR8.2 补丁导入功能（代码导入功能已实现，UI待优化）

---

**文档版本**: 2.0
**最后更新**: 2025年1月
**作者**: 需求分析团队
**更新说明**: 补充实际实现的功能特性，添加详细用例场景和交互流程
