name: ğŸš€ Deploy to Cloudflare Pages

on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  # Deploy to production when pushing to main branch
  push:
    branches: [master, main]

  # æ‹‰å–è¯·æ±‚æ—¶åˆ›å»ºé¢„è§ˆéƒ¨ç½²
  # Create preview deployment for pull requests
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened, closed]

# å…è®¸å¹¶å‘è¿è¡Œï¼Œä½†å–æ¶ˆæ—§çš„é¢„è§ˆéƒ¨ç½²
# Allow concurrent runs but cancel old preview deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # é¢„è§ˆéƒ¨ç½²ï¼ˆé’ˆå¯¹PRï¼‰
  # Preview deployment (for PRs)
  preview:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    outputs:
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ä¸‹è½½ç´¢å¼•æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
      # Download index data (if needed)
      - name: ğŸ“Š Download indexes
        uses: actions/checkout@v4
        with:
          ref: 'indexes'
          path: 'tmp_indexes'
        continue-on-error: true

      - name: ğŸ“ Setup indexes
        run: |
          if [ -d "tmp_indexes/indexes" ]; then
            mv tmp_indexes/indexes ./
          fi

      - name: ğŸ“„ Copy PDF.js
        run: cp -r ./node_modules/pdfjs-dist ./public/ || true

      - name: ğŸ—ï¸ Build project
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: ğŸš€ Deploy to Cloudflare Pages (Preview)
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: banned-historical-archives
          directory: out
          # é¢„è§ˆéƒ¨ç½²ä¸ä¼šæ›´æ–°ç”Ÿäº§ç¯å¢ƒ
          # Preview deployment doesn't update production
          production: false
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Preview deployment ready!**\n\nğŸ“± **Preview URL:** ${{ steps.deploy.outputs.url }}\n\nThis preview will be automatically updated when you push new changes to this PR.`
            })

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆæ¨é€åˆ°ä¸»åˆ†æ”¯ï¼‰
  # Production deployment (pushed to main branch)
  production:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # ç¡®ä¿æœ‰æœ€æ–°çš„ç´¢å¼•æ•°æ®
      # Ensure latest index data
      - name: ğŸ“Š Download indexes
        uses: actions/checkout@v4
        with:
          ref: 'indexes'
          path: 'tmp_indexes'
        continue-on-error: true

      - name: ğŸ“ Setup indexes
        run: |
          if [ -d "tmp_indexes/indexes" ]; then
            mv tmp_indexes/indexes ./
          fi

      - name: ğŸ“„ Copy PDF.js
        run: cp -r ./node_modules/pdfjs-dist ./public/ || true

      - name: ğŸ—ï¸ Build project
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: ğŸš€ Deploy to Cloudflare Pages (Production)
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: banned-historical-archives
          directory: out
          # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
          # Production deployment
          production: true
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Update deployment status
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              deployment_id: context.payload.deployment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.url }}'
            })

  # æ¸…ç†å…³é—­çš„PRé¢„è§ˆ
  # Cleanup closed PR previews
  cleanup:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write

    steps:
      - name: ğŸ§¹ Cleanup preview deployment
        run: |
          echo "PR #${{ github.event.number }} closed, preview deployment will be cleaned up automatically by Cloudflare Pages"
